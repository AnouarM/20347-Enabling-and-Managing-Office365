# Lab Answer Key:  Module 13: Planning and configuring identify federation
# Lab: Planning and configuring identity federation

## Exercise 1: Deploying Active Directory Federation Services (AD FS) and Web Application Proxy
  
#### Task 1: Add DNS records required for AD FS
  
<<<<<<< HEAD
1. On LON-DS1, select  **Start** and then select **Windows PowerShell**.

2. Type  **IPConfig** and press Enter.

3. Record the IPv4 address assigned to the server. 

4. On LON-DC1, open Server Manager, select  **Tools**, and then select  **DNS**.

5. Expand  **LON-DC1**, expand  **Forward Lookup Zones**, and then select  **Adatumyyxxxxx.hostdomain.com**.

6. Right-select  **Adatumyyxxxxx.hostdomain.com**, and then select  **New Host (A or AAAA)**.

7. In the New Host dialog box, leave the Name box empty, in the  **IP address** box, type the External IP address provided by the hosting partner.

8. Select  **Add Host**, and then select  **OK**. 

9. In the New Host dialog box, leave the Name box empty, in the  **IP address** box, type the LON-DS1 IP address that you recorded in Step 3.

10. Select  **Add Host**, select  **OK**, and then select  **Done**.



#### Task 2: Install and configure the AD FS server role
  
1. Sign in to the  **LON-DS1** virtual machine as **ADATUM\\Administrator** with a password of **Pa55w.rd**.

2. Select Start, right select  **Windows PowerShell**, and then select  **Run as Administrator**.

3. At the command prompt, type the following command and press Enter. This command creates the Key Distribution Services root key to generate group Managed Service Account passwords for the account that will be used later in this lab. You should receive a Guid value as a response to this command.

  ```
  Add-KdsRootKey -EffectiveTime ((get-date).addhours(-10))
  ```

4. Select Start and then select  **Server Manager**.

5. In Server Manager, select  **Manage**, and then select  **Add Roles and Features**. If you get a Server Manger message about collecting inventory data, select  **OK**. Wait a minute and then try this step again.

6. In the Add Roles and Features Wizard, on the  **Before you begin page**, select  **Next**.

7. On the  **Select installation type** page, select **Role-based or Feature-based installation**, and then select  **Next**.

8. On the  **Select destination server** page, select **Select a server from the server pool**, verify that the target computer is highlighted, and then select  **Next**.

9. On the  **Select server roles** page, select **Active Directory Federation Services**, and then select  **Next**.

10. On the  **Select features** page, select **Next**.

11. On the  **Active Directory Federation Service (AD FS)** page, select **Next**.

12. On the  **Confirm installation selections** page, select **Install**.

13. When installation completes, on the  **Installation progress** page, select **Close**.

14. Select the exclamation mark icon on the toolbar, and then select  **Configure the federation service on this server**.

15. In the  **Active Directory Federation Services Configuration Wizard**, on the  **Welcome** page, select **Create the first federation server in a federation server farm**, and then select  **Next**.

16. On the  **Connect to AD DS** page, select **Next**.

17. On the  **Specify Service Properties** page, use the following settings, and then select **Next**:

  - For  **SSL Certificate**, select the wild card certificate provided by the hosting partner.
=======
1. Sign in to the  **LON-DS1** virtual machine as **ADATUM\\Administrator** with a password of **Pa55w.rd**.

2. On LON-DS1, select  **Start** and then select **Windows PowerShell**.

3. Type  **IPConfig** and press Enter.

4. Record the IPv4 address assigned to the server. 

5. On LON-DC1, open Server Manager, select  **Tools**, and then select  **DNS**.

6. Expand  **LON-DC1**, expand  **Forward Lookup Zones**, and then select **Adatumyyxxxxx.hostdomain.com**.

7. Right-click  **Adatumyyxxxxx.hostdomain.com**, and then select  **New Host (A or AAAA)**.

8. In the New Host dialog box, leave the Name box empty, in the  **IP address** box, type the External IP address provided by the hosting partner.

9. Select  **Add Host**, and then select  **OK**. 

10. In the New Host dialog box, leave the Name box empty, in the  **IP address** box, type the LON-DS1 IP address that you recorded in Step 3.

11. Select  **Add Host**, select  **OK**, and then select  **Done**.


#### Task 2: Create an Office 365 administrator account

1. On LON-CL1, in the Office 365 Admin center, select **Users**, then select **Active users**.

2. Select **Add a user**.

3. In the **Display name** field, enter **Admin**.

4. In the **Username** field, enter **admin** and verify that **Adatumyyxxxx.onmicrosoft.com** is selected as the **Domain**.
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e

5. Under **Password**, select **Let me create the password**, and enter the password you created on Module 1.

6. Clear the **Make this user change their password when they first sign in** option.

<<<<<<< HEAD
18. On the  **Specify Service Account** page, select the option **Create a Group Managed Service Account**, for  **Account Name** type **svc-ADFS**, and then select  **Next**.

19. On the  **Specify Configuration Database**, select  **Create a database on this server using Windows Internal Database**, and then select  **Next**.

20. On the  **Review Options** page, select **Next**.

21. Once the prerequisites check is complete, on the  **Pre-requisite Checks** page, select **Configure**. Note : Some warnings are expected to be shown.

22. When the configuration completes, on the  **Results** page, select **Close**.
=======
7. Under **Roles**, select **Global administrator**.

8. Under **Product licenses** select **Create user without product license**, then select **Add**.

9. Close the **Admin** user window.


>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e



#### Task 3: Configure and verify Azure AD Connect federation with AD FS
  
1. Switch to **LON-DS1**.

<<<<<<< HEAD
2. Select Start and then select  **Server Manager**.

3. In Server Manager, select  **Manage**, and then select  **Add Roles and Features**.

4. In the Add Roles and Features Wizard, on the  **Before you begin** page, select **Next**.

5. On the  **Select installation type** page, select **Role-based or Feature-based installation**, and then select  **Next**.

6. On the  **Select destination server** page, select **Select a server from the server pool**, verify that the target computer is highlighted, and then select  **Next**.

7. On the  **Select server roles** page, select **Remote Access**, and then select  **Next**.

8. On the Select features page, select  **Next**.

9. On the Remote Access page, select  **Next**.

10. On the  **Select role services** page, select **Web Application Proxy**, in the popup window, select  **Add Features**, and then select  **Next**.

11. On the  **Confirm installation selections** page, select **Install**.

12. When the installation is complete, on the  **Installation progress** page, select **Close**.
=======
2. On the Desktop, double-click **Azure AD connect**.

3. Select **Configure**.

4. Select **Change user sign-in** and select **Next**.

5. Sign in as **Admin@Adatumyyxxxxx.onmicrosoft.com** with password created in Module 1

6. Select **Federation with AD FS**, then select **Next**.

7. On the **Domain Administrator credentials** page, enter the USERNAME **ADATUM\\administrator** and PASSWORD **Pa55w.rd**, then select **Next**.

8. Select **Use a certificate installed on the federation servers** and select **Browse**.

9. In the **Search** box enter **LON-DS1** and select the Search icon.

10. Select **LON-DS1.Adatum.com**, then select **OK**.

11. In the **CERTIFICATE FILE** drop-down, select the certificate provided by the lab provider.

12. In the **SUBJECT NAME** drop-down, select the subject name that matches the certificate.
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e

13. In the **SUBJECT NAME PREFIX** box enter the _yyxxxx__ value provied by the lab provider, and select **Next**.

<<<<<<< HEAD
#### Task 4: Configure the Web Application Proxy server
  
1. On LON-WAP1, in Server Manager, select  **Tools**, and then select  **Remote Access Management**.

2. In the Remote Access Management Console, in the left navigation pane, select  **Web Application Proxy**. In the middle navigation pane, select  **Run the Web Application Proxy Configuration Wizard**.

3. In the Web Application Proxy Configuration Wizard, on the  **Welcome** page, select **Next**.

4. On the  **Federation Server** page, use the following settings, and then select **Next**:
=======
14. On the **AD FS servers** page select **Browse**.
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e

15. In the **Search** box type **LON-DS1** and select the Search icon.

16. Select **LON-DS1** then select **OK**.

17. After the connection has been verified, select **Next**.

<<<<<<< HEAD
5. On the  **AD FS Proxy Certificate** page, select the **adfs.adatumyyxxxxx.hostdomain.com** certificate, and then select **Next**.

6. On the  **Confirmation** page, select **Configure**.

7. When the configuration is complete, on the  **Results** page, select **Close**.
=======
18. On the **Web Application Proxy servers** page, select **Browse**.

19. In the **Search** box type **LON-WAP1** and select the Search icon.

20. Select **LON-WAP1**, select **OK**, then select **Next**.
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e

21. On the **AD FS service account** page, select **Create a group Managed Service Account**, enter the following **ENTERPRISE ADMIN USERNAME** credentials, then select **Next**:
    - User name: **ADATUM\\Administrator**
    - Password: **Pa55w.rd**    

22. On the **Azure AD Domain** page, in the drop-down select **Adatumyyxxxxx.hostdomain.com** and select **Next**.

<<<<<<< HEAD
#### Task 5: Verify that the AD FS server is working
  
1. Switch to the LON-DS1 virtual machine.

2. In Server Manager, select  **Tools**, and then select  **Event Viewer**.

3. In Event Viewer, in the details pane, expand  **Applications and Services Logs**, expand  **AD FS**, and then select  **Admin**.
=======
23. On the **Ready to configure** page, select **Configure**.

24. On the **Verify federation configuration** page, select **I have created DNS a records that allow clients to resolve my federation service**
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e

25. Select **Verify**.

    > The wizard will verify the AD FS server resolves to both internal and external DNS.
    > You may need to select **Verify** multiple times to verify external DNS.

26. Select **Exit**.

<<<<<<< HEAD
6. If you get a message stating  **There is a problem with this website's security certificate**, select  **Continue to this website**. 

  >  **Note:** The expected output is a display of XML with the service description document. If this page displays, then Microsoft Internet Information Services (IIS) on the federation server is operational and serving pages successfully.
  
  <!-- -->
=======
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e
  
>  **Result**: After completing this exercise, you should have deployed the AD FS server in a federation server farm, and deployed the Web Application Proxy server to support AD FS.


<<<<<<< HEAD
## Exercise 2: Configuring federation with Microsoft Office 365
  
#### Task 1: Switch the Office 365 tenant to federated mode
  
1. Switch to the LON-DS1 virtual machine.

2. Open Internet Explorer, and then connect to  **https://portal.office.com**.

3. Sign in as **Beth@adatumyyxxxxx.hostdomain.com** with the password you created in Module 1.

4. Select  **Admin**.

5. If you are connected to the previous Office 365 admin center, select the banner at the top of the page to access the new Office 365 admin center

6. Select  **Users** and then select **Active Users**.

7. Select  **Beth Burke**, and then, in the  **User name/Email Aliases** section, select **Edit**.

8. Change the primary email alias to  **Adatumyyxxxxx.onmicrosoft.com**. In the Warning window, select  **Save**, and then select  **Sign Out**.

9. Close Internet Explorer. 

  >  **Note:** Beth cannot change the Adatumyyxxxxx.hostdomain.com to a federated domain if she is logged in using an account from this domain. 

10. Select Start, and then select the  **Windows PowerShell** icon.

11. At the Windows PowerShell prompt, type the following commands, pressing Enter at the end of each line:

  ```
  Set-ExecutionPolicy Unrestricted -force
  Import-Module MSOnline
  ```

12. At the Windows PowerShell prompt, type the following command, and then press Enter:

  ```
  $msolcred = Get-Credential
  ```

13. In the  **Windows PowerShell Credential** dialog box, enter the following credentials, and then select **OK**:

  - User name:  **Beth@Adatumyyxxxxx.onmicrosoft.com**

  - Password:  the password you created in Module 1


14. At the Windows PowerShell prompt, type the following command, and then press Enter:

  ```
  Connect-MsolService -Credential $msolcred
  ```

15. At the Windows PowerShell prompt, type the following command, and then press Enter:

  ```
  Get-MsolDomain
  ```

16. Verify that your lab domain, Adatumyyxxxxx.hostdomain.com, is listed as  **Verified and Managed**.

  >  **Note:** If you were running this from a computer other than the AD FS federation server, you would need to use the **Set-MsolAdfsContext** to reference the AD FS server.

17. At the Windows PowerShell prompt, type the following command, and then press Enter:

  ```
  Convert-MsolDomainToFederated -DomainName Adatumyyxxxxx.hostdomain.com
  ```

18. Verify that you get a  **Successfully updated Adatumyyxxxxx.hostdomain.com domain** message.

19. At the Windows PowerShell prompt, type the following command, and then press Enter:

  ```
  Get-MsolFederationProperty -DomainName Adatumyyxxxxx.hostdomain.com
  ```

  >  **Note:** This command reports the status of the domain federation, and provides details of URLs and certificates.
  
<!-- -->

>  **Result**: After completing this exercise, you should have enabled a federation trust between your on-premises Active Directory domain and Office 365 through your AD FS federation server, and you should have converted your domain for federated authentication in Office 365.


=======
>>>>>>> 564fac958c055fa078a71c9b7d1045dffc25797e
## Exercise 3: Verifying single sign-on (SSO)
  
#### Task 1: Verify SSO for internal users
  
1. Switch to **LON-CL3**.

2. On LON-CL3, open Microsoft Edge, and then connect to  **https://portal.office.com**.

3. Type  **beth@adatumyyxxxxx.hostdomain.com** as the user name, and then press Tab.

4. Verify that you are redirected to the Adatum sign in page.

5. Type  **Pa55w.rd** as the password, and then press Enter.

6. Verify that you are connected to Office 365. 

7. Close Microsoft Edge.



#### Task 2: Verify SSO for external users
  
1. On your local computer, open a Web browser (use an **InPrivate browsing** window, if possible). 

2. In the Address bar, type  **https://portal.office.com**, and then press Enter.

3. Type  **grover@adatumyyxxxxx.hostdomain.com** as the user name, and then press Tab.

4. Verify that you are redirected to the Adatum sign in page.

5. Type  **Pa55w.rd** as the password, and then press Enter.

6. Review the Office 365 page for Grover Chambliss, and then close the Web browser window.


>  **Result**: After completing this exercise, you should have verified SSO authentication to Office 365 for a user on your corporate network and for a user on your host computer that is connected to the Internet.



©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply.  All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant.  This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  
